name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install
      
    - name: Build web app
      run: npm run build
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Check and Setup Android
      run: |
        if [ -d "android" ] && [ -f "android/build.gradle" ]; then
          echo "Android 项目已存在，直接使用"
          npx cap sync android
        else
          echo "Android 项目不存在，创建新项目"
          npx cap init "极简记账" "com.ledger.app" --web-dir dist
          npx cap add android
        fi
        
    - name: Fix Kotlin Conflict
      run: |
        # 修复 Kotlin 依赖冲突
        cat > android/build.gradle << 'GRADLEEOF'
        buildscript {
            ext.kotlin_version = '1.8.22'
            
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.7.2'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
                classpath 'com.google.gms:google-services:4.4.2'
            }
        }

        apply from: "variables.gradle"

        allprojects {
            repositories {
                google()
                mavenCentral()
            }
            
            configurations.all {
                resolutionStrategy {
                    force "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
                    force "org.jetbrains.kotlin:kotlin-stdlib-common:$kotlin_version"
                    force "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
                    force "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
                }
            }
        }

        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        GRADLEEOF
        
    - name: Fix Android SDK versions
      run: |
        sed -i 's/compileSdkVersion = .*/compileSdkVersion = 35/' android/variables.gradle
        sed -i 's/targetSdkVersion = .*/targetSdkVersion = 35/' android/variables.gradle
        
    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon
        
    - name: Upload APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: 极简记账-Debug-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk
        
    - name: Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: 极简记账 v${{ github.run_number }}
        body: |
          自动构建的测试版本
          
          ## 安装方法
          1. 下载 `app-debug.apk`
          2. 传到安卓手机安装
          3. 如果提示未知来源，请允许安装
        files: android/app/build/outputs/apk/debug/app-debug.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
